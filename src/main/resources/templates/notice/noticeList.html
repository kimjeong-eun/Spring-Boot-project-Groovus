<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity6"
      layout:decorate="~{layout/basic.html}">
<head>
  <meta charset="UTF-8">
  <title>공지사항</title>

  <th:block layout:fragment="css">

    <style>

      #logoImg{
        background-color: #0435d7;
      }

      .modal_{
        position:absolute;
        display:none;
        justify-content: center;
        top:0;
        left:0;
        z-index:99999;
        width:100%;
        height:100%;

        background-color: rgba(0,0,0,0.4);
      }

      .modal_body{
        position:absolute;
        top:5%; /* 모달을 화면가운데 놓기위함.  */

        width:50rem;  /* 모달의 가로크기  */
        height:55rem; /* 모달의 세로크기  */
        padding:40px;

        background-color: rgb(255,255,255);
        border-radius:10px;
        box-shadow:0 2px 3px 0 rgba(34,36,38,0.15);

        transform:translateX(25%);
      }


    </style>

  </th:block>
</head>

<th:block layout:fragment="content">

  <div class="row page-titles mx-0">
    <div class="col p-md-0">
      <ol class="breadcrumb">
        <li class="breadcrumb-item active"><a href="javascript:void(0)">notice</a></li>
      </ol>
    </div>
  </div>

  <div class="container-fluid">
    <div class="row">
      <div class="col-lg-12">
        <div class="card">
          <div class="card-body">
            <div class="email-left-box">

              <button type="button" class="btn btn-primary btn-block" style="background-color: #0435d7;" name="registernoticeBtn">새글등록</button>

              <div class="mail-list mt-4">
                <a href="#" class="list-group-item border-0 text-primary p-r-0"><span class="fa fa-briefcase f-s-14 mr-2"></span> <b>전체글</b> <span class="badge badge-primary badge-sm float-right m-t-5" name="wholenotice">0</span> </a>
                <a href="#" class="list-group-item border-0 p-r-0"><i class="fa fa-star-o font-18 align-middle mr-2"></i>즐겨찾기 <span class="badge badge-danger badge-sm float-right m-t-5">47</span> </a>
                <a href="#" class="list-group-item border-0 p-r-0"><i class="fa fa-trash font-18 align-middle mr-2"></i>삭제글</a>
              </div>
            </div>
            <div class="email-right-box">
              <!--업무리스트 시작-->
              <div class="card-body" name="mainContent">
                <div name="mainList">
                  <div class="card-title">
                    <h4>공지사항</h4>
                  </div>
                  <div class="table-responsive" >
                    <table class="table">
                      <thead>
                      <tr>
                        <th>#</th>
                        <th>제목</th>
                        <th>등록일</th>
                        <th>작성자</th>
                      </tr>
                      </thead>

                    </table>
                    <!--페이징-->
                    <div class="bootstrap-pagination">
                      <nav>
                        <ul class="pagination justify-content-end">
                          <li class="page-item" th:if="${responseDTO.prev}"><a class="page-link" th:data-num="1"><b><<</b></a>
                          </li>

                          <th:block th:each="i : ${#numbers.sequence(1,responseDTO.lastPage)}">
                            <li th:class="${responseDTO.page == i}?'page-item active':'page-item'">
                              <a class="page-link" th:data-num="${i}">[[${i}]]</a>
                            </li>
                          </th:block>

                          <li class="page-item" th:if="${responseDTO.next}">
                            <a class="page-link" th:data-num="${responseDTO.lastPage}"><b>>></b></a>
                          </li>
                        </ul>
                      </nav>
                    </div>
                    <!--페이징 끝-->
                  </div>
                </div>
              </div>
              <!--업무리스트 끝-->

              <!-- panel -->
              <!--여기에 페이징 예정-->
              <div class="row">
                <!-- <div class="col-7">
                     <div class="text-left">1 - 20 of 568</div>
                 </div>
                 <div class="col-5">
                     <div class="btn-group float-right">
                         <button class="btn btn-gradient" type="button"><i class="fa fa-angle-left"></i>
                         </button>
                         <button class="btn btn-dark" type="button"><i class="fa fa-angle-right"></i>
                         </button>
                     </div>-->
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  </div>

  <!--모달창-->
  <div class="modal_">
    <div class="modal_body">
      <span  name="modal_close_btn" style="width: 3rem; height: 3rem; font-size: 30px; float:right ; margin-bottom: 1rem; cursor: pointer;"> X </span>
      <br/>

      <form name="noticeForm" method="post" action="/notice/register">
        <span><b>제목</b></span>
        <input type="text" class="form-control input-default" placeholder="업무 제목 입력 (필수)" name="noticeTitle" style="display: inline-block; width: 25rem; margin-left: 1rem;">
        <br/>
        <br/>
        <span><b>작성자</b></span>
        <input type="text" class="form-control input-default" name="noticeWriter" th:value="${#authentication.principal.uid}" style="display: inline-block; width: 20rem; margin-left: 2rem;" readonly>
        <br/>
        <br/>
        <!--        <span> <button type="button" class="btn btn-dark mb-2" name="addBtn" style=""> + </button> </span>-->

        <div class="card-body">
          <span><b>첨부파일</b></span>
          <div class="basic-form">
            <div class="form-group">
              <input type="file" class="form-control-file">
            </div>
          </div>
        </div>

        <!--에디터-->
        <!--'note-editable panel-body' 안에 들어감-->
        <div class="card">
          <div class="card-body">
            <div class="summernote" style="display: none;" method="post">
            </div>
          </div>
        </div>
        <!--에디터 끝-->

        <input type="hidden" name="noticeContent" value="">
        <input type="hidden" name="pid" th:value="${pid}">
        <input type="hidden" name="projectName" th:value="${projectName}">
      </form>
      <button type="button" class="btn mb-1 btn-info" name="registerBtn">등록</button>
    </div>
  </div>
  <!--모달 끝-->

  <div name="noticeDetailsArea">

    <!--업무 상세보기-->
    <div name="noticeDetails" style="display: none">
      <span><button type="button" class="btn mb-1 btn-rounded btn-outline-light" name="readnoticeBack">뒤로</button></span>
      <span><button type="button" class="btn mb-1 btn-rounded btn-outline-success" name="readnoticeModify">수정</button></span>
      <span><button type="button" class="btn mb-1 btn-rounded btn-outline-danger" name="readnoticeDelete">삭제</button></span>

      <!--숨김항목-->
      <input type="hidden" name="readnoticeTid">

      <br/> <br/>
      <span><b>제목</b></span>
      <input type="text" class="form-control input-default" name="readnoticeTitle" style="display: inline-block; width: 25rem; margin-left: 1rem;" readonly>
      <br/> <br/>
      <br/> <br/>
      <span><b>작성자</b></span>
      <input type="text" class="form-control input-default" name="readnoticeWriter"  style="display: inline-block; width: 20rem; margin-left: 2rem;" readonly>
      <br/> <br/>
      <span><b>작성일</b></span>
      <input type="text" class="form-control input-default" name="readnoticeRegDate" style="display: inline-block; width: 25rem; margin-left: 2rem;" readonly>
      <br/> <br/> <br/>  <br/>
      <div name="readnoticeContent" class="form-control input-default" style="height:auto;"><span><button type="button" class="btn mb-1 btn-info" name="statusChangeBtn" style="display: none">변경</button></span>
      </div>
      <span><button type="button" class="btn mb-1 btn-info" name="statusChangeBtn" style="display: none">변경</button></span>



    </div>

    <!--업무 상세보기창 끝-->


  </div>


  <!--스크립트-->
  <script th:inline="javascript">

    var pid = [[${pid}]];

    $(document).ready(function (){

      var mainList = $("div[name='mainList']");

      $(document).keydown(function(event){
        if(event.keyCode == 116) { // F5 키 눌렸을 때
          event.preventDefault(); // 기본 동작 방지
          var newUrl = "/project/notice/"+[[${pid}]]+"/"+[[${projectName}]];
          location.href = newUrl;
        }
      });

      /* ajax로 프로젝트의 전체 업무 개수를 얻어옴*/
      $.ajax({
        url:'/notice/countall',
        type:'post',
        data:{'pid':pid},
        success:function (result){
          $("span[name='wholenotice']").text(result);
        }
      })

      //프로젝트 등록하기 버튼을 눌렀을 때
      $("button[name='registernoticeBtn']").on("click",function (e){
        e.preventDefault();
        $(".modal_").show();
      });

      //모달 닫기 버튼을 눌렀을 때
      $(document).on("click","span[name='modal_close_btn']",function(){
        $(".modal_").hide();
      });

      //업무읽기에서 뒤로가기 버튼이 눌렸을 때
      $(document).on("click","button[name='readnoticeBack']",function (e){
        e.preventDefault();

        $("button[name='statusChangeBtn']").hide();
        $("div[name='noticeDetailsArea']").html( $("div[name='noticeDetails']")); //업무 상세보기창 이동

        $("div[name='noticeDetails']").hide(); //숨김

        $("div[name='mainContent']").html(mainList); //메인콘텐츠공간에 메인리스트 이동
      })


      //업무 제목을 눌렀을때 (업무내용 보일예정)
      $(document).on("click","td[name='readnotice']",function (e){

        e.preventDefault();
        var tid = $(this).data("tid");

        $.ajax({
          url:'/notice/view',
          type:'post',
          data:{'tid':tid},
          success:function (result){
            console.log(result);
            readnotice(result);
          }
        });

      });

      //업무 읽기
      function readnotice(result){

        var noticeDetails = $("div[name='noticeDetails']"); //업무 상세보기 창

        var selectStatus = $("select[name='readnoticeStatus']");

        $("input[name='readnoticeTid']").val(result.tid);
        $("input[name='readnoticeTitle']").val(result.noticeTitle);
        $("input[name='readnoticeWriter']").val(result.noticeWriter);
        $("input[name='readResponsibleMember']").val(result.responsibleMember);
        $("input[name='readnoticeRegDate']").val(result.regDate);
        selectStatus.val( result.status);
        $("div[name='readnoticeContent']").html(result.noticeContent);
        noticeDetails.show();

        $("div[name='mainContent']").html(noticeDetails); //메인 콘텐츠쪽에 넣음
      }

    });

    //업무 상세보기 -> 상태변경 셀렉트 박스에 변경이 감지되면
    $("select[name='readnoticeStatus']").change(function (){

      //변경 버튼 노출
      $("button[name='statusChangeBtn']").show();
    })

    //업무의 상세보기 -> 변경 버튼이 눌렸을 때
    $("button[name='statusChangeBtn']").on("click",function (e){
      e.preventDefault();

      var tid = $("input[name='readnoticeTid']").val();
      alert(tid);

    })



    $(document).on("click","button[name='registerBtn']",function (e){
      //업무 등록 버튼 눌렀을때
      e.preventDefault();

      var noticeForm = $("form[name='noticeForm']");
      var htmlStr = $("div.note-editable").html();

      $("input[name='noticeContent']").val(htmlStr);

      noticeForm.submit();

    })

    //페이징 버튼을 눌렀을 때
    $("a.page-link").on("click", function (event) {

      event.preventDefault(); // 링크의 기본 동작을 중단합니다.

      var pageNum = $(this).data("num");
      var mid = [[${mid}]];
      var type = [[${pageRequestDTO.type}]];
      var keyword = [[${pageRequestDTO.keyword}]];

      if(type != null && keyword!=null){
        var url = '/notice/list/'+[[${pid}]]+'/'+[[${projectName}]]+'?page='+pageNum+'&type='+type+'&keyword='+keyword;
      }else{
        var url = '/notice/list/'+[[${pid}]]+'/'+[[${projectName}]]+'?page='+pageNum;
      }
      window.location.href = url; // 새로운 URL로 이동합니다.
    });

  </script>

</th:block>

</html>