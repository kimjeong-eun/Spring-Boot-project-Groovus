<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity6"
      layout:decorate="~{layout/basic.html}">
<head>
  <meta charset="UTF-8">
  <title>쪽지함</title>
  <th:block layout:fragment="css">

    <style>

      #logoImg{
        background-color: #56c53d;
      }

    </style>

  </th:block>
</head>

<th:block layout:fragment="content">

    <div class="row page-titles mx-0">
      <div class="col p-md-0">
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a href="javascript:void(0)">[[${projectName}]]</a></li>
          <li class="breadcrumb-item active"><a href="javascript:void(0)">쪽지함</a></li>
        </ol>
      </div>
    </div>
    <!-- row -->

    <div class="container-fluid">
      <div class="row">
        <div class="col-lg-12">
          <div class="card">
            <div class="card-body">

              <div class="email-left-box"><a href="#" class="btn btn-primary btn-block" style="background-color: #56c53d;" id="sendMessage">쪽지쓰기</a>
                <div class="mail-list mt-4">
                  <a href="#" class="list-group-item border-0 text-primary p-r-0"><i class="fa fa-inbox font-18 align-middle mr-2"></i> <b>쪽지함</b> <span class="badge badge-primary badge-sm float-right m-t-5">198</span> </a>
                  <a href="#" class="list-group-item border-0 p-r-0"><i class="fa fa-paper-plane font-18 align-middle mr-2"></i>보낸쪽지</a>
                  <a href="#" class="list-group-item border-0 p-r-0"><i class="fa fa-trash font-18 align-middle mr-2"></i>휴지통</a>
                </div>
              </div>

              <div class="email-right-box">
                <div role="toolbar" class="toolbar">
                  <div class="btn-group">
                    <button aria-expanded="false" data-toggle="dropdown" class="btn btn-dark dropdown-toggle" type="button">More <span class="caret m-l-5"></span>
                    </button>
                    <div class="dropdown-menu"><span class="dropdown-header">More Option :</span>  <a href="javascript: void(0);" class="dropdown-item">Mark as Unread</a>  <a href="javascript: void(0);" class="dropdown-item">Add to Tasks</a>  <a href="javascript: void(0);" class="dropdown-item">Add Star</a>  <a href="javascript: void(0);" class="dropdown-item">Mute</a>
                    </div>
                  </div>
                </div>

                <!--메인콘텐츠쪽-->
                <div class="card-body" name="mainContent">

                  <div name="mainList">
                    <div class="card-title">
                      <h4>[[${#authentication.principal.uid}]]의 쪽지함</h4>
                    </div>
                    <div class="table-responsive" >
                      <table class="table">
                        <thead>
                        <tr>
                          <th>📬</th>
                          <th>제목</th>
                          <th>읽음/안읽음</th>
                          <th>전송일</th>
                          <th>보낸이</th>
                        </tr>
                        </thead>
                        <tbody>
                            <th:block th:each="message , i : ${responseDTO.dtoList}">
                              <tr>
                                <th>[[${i.index + responseDTO.start }]]</th>
                                <td name="messageTitle" class="messageTitle" th:data-tid="${message.lid}">[[${message.title}]]</td>
                                <td th:if="${#strings.equals(message.messageStatus, 'UNREAD')}"><span class="badge badge-danger px-2">안읽음</span></td>
                                <td th:if="${#strings.equals(message.messageStatus, 'READ')}"><span class="badge badge-light px-2">읽음</span></td>
                                <td> [[${#temporals.format(message.sendDate, 'yyyy/MM/dd')}]]</td>
                                <td class="color-primary">[[${message.sender}]]</td>
                              </tr>

                            </th:block>
                        </tbody>
                      </table>
                      <!--페이징-->

                      <!--페이징 끝-->
                    </div>
                  </div>

                </div>

                <!-- 메인 콘텐트 끝 -->

              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

  <div name="writeMessageFormArea">

    <div class="email-right-box" style="margin-left: 0; display: none;" name="writeMessageForm">
      <div class="toolbar" role="toolbar">
        <div class="btn-group m-b-20">
          <button type="button" class="btn btn-light"><i class="fa fa-archive"></i>
          </button>
          <button type="button" class="btn btn-light"><i class="fa fa-exclamation-circle"></i>
          </button>
          <button type="button" class="btn btn-light"><i class="fa fa-trash"></i>
          </button>
        </div>
        <div class="btn-group m-b-20">
          <button type="button" class="btn btn-light dropdown-toggle" data-toggle="dropdown"><i class="fa fa-folder"></i>  <b class="caret m-l-5"></b>
          </button>
          <div class="dropdown-menu"><span class="dropdown-header">Move to</span>  <a class="dropdown-item" href="javascript: void(0);">Social</a>  <a class="dropdown-item" href="javascript: void(0);">Promotions</a>  <a class="dropdown-item" href="javascript: void(0);">Updates</a>
            <a class="dropdown-item" href="javascript: void(0);">Forums</a>
          </div>
        </div>
        <div class="btn-group m-b-20">
          <button type="button" class="btn btn-light dropdown-toggle" data-toggle="dropdown"><i class="fa fa-tag"></i>  <b class="caret m-l-5"></b>
          </button>
          <div class="dropdown-menu"><span class="dropdown-header">Label as:</span>  <a class="dropdown-item" href="javascript: void(0);">Updates</a>  <a class="dropdown-item" href="javascript: void(0);">Social</a>  <a class="dropdown-item" href="javascript: void(0);">Promotions</a>
            <a class="dropdown-item" href="javascript: void(0);">Forums</a>
          </div>
        </div>
        <div class="btn-group m-b-20">
          <button type="button" class="btn btn-light dropdown-toggle" data-toggle="dropdown">More <span class="caret m-l-5"></span>
          </button>
          <div class="dropdown-menu"><span class="dropdown-header">More Option :</span>  <a class="dropdown-item" href="javascript: void(0);">Mark as Unread</a>  <a class="dropdown-item" href="javascript: void(0);">Add to Tasks</a>  <a class="dropdown-item" href="javascript: void(0);">Add Star</a>  <a class="dropdown-item" href="javascript: void(0);">Mute</a>
          </div>
        </div>
      </div>
      <div class="compose-content mt-5">
        <form action="#">
          <input type="hidden" name="sender" th:value="${#authentication.principal.uid}">
          <div class="form-group">
           <label for="receiver">받는사람</label>
            <br/>
            <span>
              <select name="memberSelect" style="width: 10rem;">
                <option value="">------</option>
                <!--여기에 멤버 리스트 들어갈 것-->


              </select>
            </span>
            <br/>
            <br/>
            <input type="text" class="form-control bg-transparent" placeholder=" To" id="receiver" name="receiver" readonly>
          </div>
          <div class="form-group">
            <input type="text" class="form-control bg-transparent" placeholder="제목" name="title">
          </div>
          <div class="form-group">
            <textarea name="content" class="textarea_editor form-control bg-light" rows="15" placeholder="Enter text ..."></textarea>
          </div>
        </form>

      </div>
      <div class="text-left m-t-15">
        <button class="btn btn-primary m-b-30 m-t-15 f-s-14 p-l-20 p-r-20 m-r-10" type="button" name="sendMessageBtn"><i class="fa fa-paper-plane m-r-5"></i> 보내기 </button>
        <button class="btn btn-dark m-b-30 m-t-15 f-s-14 p-l-20 p-r-20" type="button" name="sendCancleBtn"><i class="ti-close m-r-5 f-s-12"></i> 취소 </button>
      </div>
    </div>

  </div>

    <!-- #/ container -->

  <script th:inline="javascript">

    var mainList = $("div[name='mainList']"); //메인 리스트 저장

    $(document).ready(function (){

      var pid = [[${pid}]];

      $.ajax({
        url:'/project/memberList',
        data:{'pid':pid},
        method:'post',
        success:function (result){
          insertMemberList(result);
        }
      });

      //멤버 리스트 출력함수
      function insertMemberList(result){

        var selectList = $("select[name='memberSelect']");
        var str ='';
        for(var member of result){

          str+='<option value="'+member.mid+'">'+member.uid+'</option>';

        }
        selectList.append(str);
      }

      $("select[name='memberSelect']").change(function (){

        $("input[name='receiver']").val($("select[name='memberSelect'] :selected").text());

      });


      $("#sendMessage").on("click",function (e){
        //쪽지 쓰기 버튼이 눌렸을 때
        e.preventDefault();

        var messageForm = $("div[name='writeMessageForm']");
        messageForm.show();
        $("div[name='mainContent']").html(messageForm);
      });

    }); //document.ready 끝

    $(document).on("click","button[name='sendCancleBtn']",function (e){
      //쪽지 쓰기 취소를 눌렀을 때
      e.preventDefault();

      var writeMessageForm = $("div[name='writeMessageForm']"); //쪽지 입력폼을
      $("div[name='writeMessageFormArea']").html(writeMessageForm); // 원래 있던 영역으로 옮김(안보이는 영역)
      writeMessageForm.hide(); //쪽지 입력폼 숨김
      $("div[name='mainContent']").html(mainList); // 미리 저장해놓았던 리스트를 다시 mainContent 영역에 넣음


    });

    $(document).on("click","button[name='sendMessageBtn']",function (e){
      e.preventDefault();

      var title = $("input[name='title']").val();
      var content = $("textarea[name='content']").val();
      var receiver = $("input[name='receiver']").val();
      var sender = [[${#authentication.principal.uid}]];

      $.ajax({
        url:'/message/send',
        type:'post',
        data:{'title':title,
        'content':content,
        'receiver':receiver,
        'sender':sender ,
        'pid':[[${pid}]]},
        success:function (result){
          if(result=='success'){
            alert("쪽지를 보냈습니다");
            location.reload();
          }
        }
      }); //ajax끝


    });





  </script>




</th:block>




</html>